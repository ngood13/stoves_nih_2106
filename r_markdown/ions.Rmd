---
title: "Carbonyls"
output:
  html_document:
    toc: true
    toc_float: true
    theme: united
---

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  library(tidyverse)
  library(knitr)
```

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  source("../r_scripts/R_load_data.R")
  source("../r_scripts/R_load_metadata.R")
  source("../r_scripts/R_tidy.R")
```

# Load data

* load carbonyls data

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  ions <- readRDS("../r_files/ions.RDS")
```

* metadata

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  test_info <- readRDS("../r_files/test_info.RDS")
  times_fuel <- readRDS("../r_files/times_fuel.RDS")
  times_bg <- readRDS("../r_files/times_bg.RDS")
  times_test <- readRDS("../r_files/times_test.RDS")
  flow <- readRDS("../r_files/flows.RDS")
  notes <- readRDS("../r_files/qc.RDS")
```

# Organize

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  ions <- tidyr::gather(ions, "var", "val", 2:17) %>%
          dplyr::select(-id)

  info <- dplyr::select(test_info, id_test, id, fuel_type, fuel_quant)

  flow <- dplyr::filter(flow, inst == "carbonyl") %>%
          dplyr::select(id, mean, delta) %>%
          dplyr::rename(flow_mean = mean,
                        flow_delta = delta)

  times <- dplyr::select(times_test, id, start, end)

  ions <- dplyr::left_join(ions, info, by = c("id_ions" = "id_test")) %>%
          dplyr::left_join(flow, by = "id") %>%
          dplyr::left_join(times, by = "id")
```

# LOD

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  ions <- dplyr::mutate(ions, lod = ifelse(is.na(val), "below", "above"))
```

# QC

* extract notes for carbonyl data

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  notes <- dplyr::filter(notes, grepl("carbonyl|all", inst))

  ions <- dplyr::left_join(ions, notes, by = "id")
```

# Concentration calculations

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
 # (ug) * 60 * 1000 / ((L / min) * (s - s)) = ug / m^3
  ions <- dplyr::mutate(ions, 
                        conc = (val) * 60 * 1000 /
                               (flow_mean * (end - start)))
```

# Background analysis

*  background average

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  ions_bg <- dplyr::filter(ions, fuel_type == "background") %>%
             dplyr::group_by(var) %>%
             dplyr::summarise(bg_mean = mean(val, na.rm = TRUE),
                              bg_sd = sd(val, na.rm = TRUE))
```

* merge

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  ions <- dplyr::left_join(ions, ions_bg, by = "var")
```

* calculate background-adjusted concentration
```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  ions$conc_bgadj <- ions$conc - ions$bg_mean
```

* calculate mass per startup replicate
```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  ions$mass_rep <- ions$val / ions$fuel_quant
  ions$mass_rep <- as.numeric(gsub("Inf", "0", ions$mass_rep))
  
```

# Summary

Ion data was collected during `r length(unique(ions$id))` experiments. There is no ion data for tests: `r setdiff(unique(test_info$id), unique(ions$id))`.

Tests 36 through 43 are blanks; no fivegas data expected.
Test 30 (ID K3) conducted on 1/17/2017.No carbonyl was collected for this test.

All carbonyl data is present as expected as of 5/24/17.

The study test notes indicated that the QC status of the available data is:
```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  single <- filter(ions,var=="acetaldehyde")
  table(single$qc) 
  print(single$id_test[which(single$qc == "bad")])
  print(single$notes.x[which(single$qc == "bad")])
  print(single$id_test[which(single$qc == "maybe")])
```


# Save merged file

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  saveRDS(ions, file = "../r_files/ions_merged.RDS")
```

# Plots

## Concentrations (ug/m3) by pollutant type

Not background adjusted -  mean background shown in black. 
```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE, fig.width=20, fig.height=40}
  ggplot(ions, aes(id, conc, colour = fuel_type)) +
  geom_point(size = 4) +
  geom_point(aes(id, bg_mean), size = 4, colour = "black") +
  theme_minimal() +
  theme(text = element_text(size = 28)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ylab("ug/m^3") +
  scale_y_log10() +
  facet_wrap(~var, ncol = 2, scales = "free")
```

## Background-corrected concentration (ug/m3) by pollutant type 
```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE, fig.width=20, fig.height=40}
  ggplot(filter(ions, fuel_type!="background"), aes(id, conc_bgadj, colour = fuel_type)) +
  geom_point(size = 4) +
  theme_minimal() +
  theme(text = element_text(size = 28)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ylab("ug/m^3") +
  #scale_y_log10() + #not sure why this line causes error when it doesn't on previous and following graph...
  facet_wrap(~var, ncol = 2, scales = "free")
```

## Background-corrected concentration (ug/m3) by fuel type, QC status noted 
```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE, fig.width=20, fig.height=40}
  ggplot(filter(ions, fuel_type!="background"), aes(id, conc, colour = qc)) +
  geom_point(size = 4) +
  theme_minimal() +
  theme(text = element_text(size = 28)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ylab("ug/m^3") +
  scale_y_log10() +
  facet_wrap(~var, ncol = 2, scales = "free")
```

## Mass (ug) per replicate accross different pollutants and fuel types (plot per pollutant, fuel type colored) 
```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE, fig.width=20, fig.height=40}
  ggplot(ions, aes(id, mass_rep, colour = fuel_type)) +
  geom_point(size = 4) +
  theme_minimal() +
  theme(text = element_text(size = 28)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ylab("average ug per starter bundle") +
  facet_wrap(~var, ncol = 2, scales = "free")
```

## Mass (ug) per replicate accross different pollutants and fuel types (plot per fuel type), QC status noted
```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE, fig.width=20, fig.height=40}
  ggplot(filter(ions, fuel_type!="background"), aes(var, mass_rep, colour = qc)) +
  geom_point(size = 4) +
  theme_minimal() +
  theme(text = element_text(size = 28)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ylab("average ug per starter bundle") +
  facet_wrap(~fuel_type, ncol = 2, scales = "free")
```

# Data Quality Conclusions (KF on 5/26/17)

Test N1 should be dropped from analysis due to bad QC and note that flow at end of test was zero due to clog; though, it looks like the clog likely occurred very close to the end of the test as the data point is in line with other data points from the other N tests. Using the pre-test flow rate as the average test flow rate may be an OK approximation to salvage this data point.

All "maybe" QC tests should be kept within the dataset. 