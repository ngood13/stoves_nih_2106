---
title: "pax"
output:
  html_document:
    toc: true
    toc_float: true
    theme: united
---

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  library(tidyverse)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  source("../r_scripts/R_tidy.R")
  source("../r_scripts/R_functions.R")
```

# Load pax data

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  pax <- readRDS("../r_files/pax.RDS")
```

# Load metadata

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  test_info <- readRDS("../r_files/test_info.RDS")
  times_fuel <- readRDS("../r_files/times_fuel.RDS")
  times_bg <- readRDS("../r_files/times_bg.RDS")
  times_test <- readRDS("../r_files/times_test.RDS")
  flow <- readRDS("../r_files/flows.RDS")
  notes <- readRDS("../r_files/qc.RDS")
```

# Organize

## sample times

* full test

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  pax_full <- filter_times_startup(times_test, pax)
```

* background levels

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  pax_bg <- filter_times_background(times_bg, pax)
```

* levels by replicate

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  pax_rep <- filter_times_rep(times_fuel, pax)
```

## Flows

* fix problem?

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  flow <- dplyr::filter(flow, inst == "pax") %>%
          dplyr::select(id, mean, delta) %>%
          dplyr::rename(flow_mean = mean,
                        flow_delta = delta)
```

* append to data

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  pax_full <- dplyr::left_join(pax_full, flow, "id")
  pax_rep <- dplyr::left_join(pax_rep, flow, "id")
  pax_bg <- dplyr::left_join(pax_bg, flow, "id")
```

# Info

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  info <- dplyr::select(test_info, id_test, id, fuel_type, fuel_quant)

  pax_full <- dplyr::left_join(pax_full, info, "id")
  pax_rep <- dplyr::left_join(pax_rep, info, "id")
  pax_bg <- dplyr::left_join(pax_bg, info, "id")
```

# QC

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  notes <- dplyr::filter(notes, grepl("pax|all", instrument))

  pax_full <- dplyr::left_join(pax_full, notes, by = "id")
  pax_rep <- dplyr::left_join(pax_rep, notes, by = "id")
  pax_bg <- dplyr::left_join(pax_bg, notes, by = "id")
```

# Save

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  saveRDS(pax_full, file="../r_files/pax_merged_full.RDS")
  saveRDS(pax_rep, file="../r_files/pax_merged_rep.RDS")
  saveRDS(pax_bg, file="../r_files/pax_merged_bg.RDS")
```


# Data summary

The PAX measured during `r length(unique(pax_full$id))` experiments between `r min(pax_full$date, na.rm = TRUE)` and `r max(pax_full$date, na.rm = TRUE)`. There is no PAX data for tests: `r setdiff(as.character(test_info$id), as.character(pax_full$id))`.

Tests 36 through 43 are blanks; no fivegas data expected.
All PAX files are present as expected as of 5/24/17. 

# Plots

## Absorption (black) and scattering (blue) by test

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE, fig.width=12, fig.height=100}
  p_data <- filter(pax_full, !is.na(id) & mode == 0)

  ggplot(p_data) +
         geom_line(mapping = aes(datetime, babs_1_mm), colour = "black") +
         geom_line(mapping = aes(datetime, bscat_1_mm), colour = "royalblue2") +
         facet_wrap(~id, ncol = 2, scales = "free") +
         theme_minimal() +
         labs(x = "", y = expression(Mm^{-1}))
```

## Absorption (black) and scattering (blue) backgrounds for each test

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE, fig.width=12, fig.height=100}
  p_data <- filter(pax_bg, !is.na(id) & mode == 0)

  ggplot(p_data) +
         geom_line(mapping = aes(datetime, babs_1_mm), colour = "black") +
         geom_line(mapping = aes(datetime, bscat_1_mm), colour = "royalblue2") +
         facet_wrap(~id, ncol = 2, scales = "free") +
         theme_minimal() +
         labs(x = "", y = expression(Mm^{-1}))
```

## Absorption (black) and scattering (blue) backgrounds for each replicate

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE, fig.width=12, fig.height=100}
  p_data <- filter(pax_rep, !is.na(id) & mode == 0)

  ggplot(p_data) +
         geom_point(mapping = aes(datetime, babs_1_mm), color = "black") +
         geom_point(mapping = aes(datetime, bscat_1_mm, color = rep)) +
         facet_wrap(~id, ncol = 2, scales = "free") +
         theme_minimal() +
         labs(x = "", y = expression(Mm^{-1}))
```

## QC

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE, fig.width=12, fig.height=100}
 p_data <- filter(pax_full, !is.na(id) & mode == 0)

  ggplot(p_data) +
         geom_line(mapping = aes(datetime, babs_1_mm, colour = qc)) +
         geom_line(mapping = aes(datetime, bscat_1_mm, colour = qc)) +
         facet_wrap(~id, ncol = 2, scales = "free") +
        theme_minimal() +
        labs(x = "", y = expression(Mm^{-1}))
```

# Data Quality Summary

No concerns!   