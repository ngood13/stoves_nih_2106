---
title: "Pollutant emissions"
output:
  html_document:
    toc: true
    toc_float: true
    theme: united
---

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  library(tidyverse)
  library(knitr)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  source("../r_scripts/R_functions.R")
```

# Load all data

* pollutant data - integrated

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
voc_merged <- readRDS("../r_files/voc_merged.RDS") #currently not complete data - missing one (shows as 0)! (emailed Arsineh on 6/27/17)
carbonyls_merged <- readRDS("../r_files/ions_merged.RDS") 
grav_merged <- readRDS("../r_files/grav_merged.RDS")
#ec/oc, PAHs - no data yet (as of 6/22/17)
```

* pollutant data - realtime

```{r}
fivegas_full <- readRDS("../r_files/fivegas_full.RDS") #also contains bg
fivegas_bg <- readRDS("../r_files/fivegas_background.RDS") #may not need since bg data is in full
    bg_co <- dplyr::filter(fivegas_bg, pol == "co")
    bg_co2 <- dplyr::filter(fivegas_bg, pol == "co2")
    bg_ch4 <- dplyr::filter(fivegas_bg, pol == "ch4")

fivegas_byrep <- readRDS("../r_files/fivegas_byrep.RDS") #may not need...

pax_full <- readRDS("../r_files/pax_merged_full.RDS")
pax_bg <- readRDS("../r_files/pax_merged_bg.RDS")
pax_byrep <- readRDS("../r_files/pax_merged_rep.RDS")
```

* fuel data
```{r}
fuel_burnt_reps <- readRDS("../r_files/fuel_burnt_reps.RDS")
fuel_burnt_test <- readRDS("../r_files/fuel_burnt_test.RDS")
```

* test times
```{r}
times_test <- readRDS("../r_files/times_test.RDS")
times_fuel <- readRDS("../r_files/times_fuel.RDS")
times_bg <- readRDS("../r_files/times_bg.RDS")
```


* constants

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  load("../r_files/hood_flow.Rda")
  load("../r_files/pol_properties.Rda")
  load("../r_files/inst_constants.Rda")
  load("../r_files/calc_constants.Rda")
```

* metadata

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  test_info <- readRDS("../r_files/test_info.RDS")
```

# calculate emissions factors

## carbonyls -FIRST ATTEMPT DONE as of 6/27/17

* select data

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  names(carbonyls_merged)[names(carbonyls_merged) =='var'] <- 'pol'
  
  carbonyls <- dplyr::select(carbonyls_merged,
                             id, qc,
                             flow_mean,
                             start, end,
                             pol, val,
                             bg_mean) %>%
               dplyr::left_join(dplyr::select(pol_properties, 
                                              pol, 
                                              mw, 
                                              num_c), by = "pol") %>%
               dplyr::filter(grepl("^[A-Z]", id) == FALSE)
```

* calculate concentrations

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  carbonyls <- dplyr::mutate(carbonyls, dur = (end - start) / 60,
                             conc = (val * 1000 / (flow_mean * dur))) #"val" originally in ug; now conc in ug/m3
# confirmed this is same as "conc" variable that was in original carbonyls_merged file (cut out in last chunk)
```

* calculate mass emitted

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  carbonyls <- dplyr::mutate(carbonyls, 
                             mass_emitted = (conc - bg_mean) * hood_flow * dur,
                             mass_carbon = mass_emitted * (num_c * mw_c / mw), #this is mass of carbon emitted for a carbon balance QC; not for calculating emissions factors. 
                             inst = "carbs")
```

* output

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  head(carbonyls, 2)
```

# ecoc - NO DATA YET (6/28/17)

* select data

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  ecoc <- dplyr::filter(ecoc_merged, type == "test", grepl("^[0-9]", id)) %>%
          dplyr::select(id, cassette,
                        start, end,
                        flow,
                        pol, ug_sq_cm,
                        conc_bg, type, qc)
```

* calculate concentrations

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  ecoc <- dplyr::mutate(ecoc, dur = (end - start) / 60,
                              conc = ug_sq_cm * filter_area * 1000 / (flow * dur))
```

* account for artifact

Use replicate average artifact (probably clean up spreadsheet at some point)

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  ecoc_a <- dplyr::group_by(ecoc, pol, id, cassette) %>%
            dplyr::summarise(rep_mean = mean(conc, na.rm = TRUE)) %>%
            dplyr::ungroup() %>%
            tidyr::spread(cassette, rep_mean) %>%
            dplyr::mutate(a = ifelse(is.na(a), 0, a)) %>%
            dplyr::mutate(conc_cor = e - a)

  ecoc <- dplyr::left_join(
            dplyr::filter(ecoc, cassette == "e"),
            dplyr::select(ecoc_a, -a, -e), 
          by = c("id", "pol"))
```

* calculate mass emitted

Concentration is corrected for background by removing background test average concentration from each test.

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  ecoc <- dplyr::mutate(ecoc, 
                        mass_emitted = (conc_cor - conc_bg) * hood_flow * dur,
                        mass_carbon = mass_emitted,
                        inst = "ecoc")
```

* output

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  head(ecoc, 2)
```

___

# fivegas - DATA GOOD BUT HAVE NOT ATTEMPTED TO RUN CODE YET

* select co, co2 and ch4.

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  co_co2_ch4 <- dplyr::filter(fivegas_full, pol == "co" | pol == "co2" | pol == "ch4")
```

* filter out data from outside emissions window

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  co_co2_ch4 <- filter_times(times_test, co_co2_ch4)
```

* calculate average for each test

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  co_co2_ch4 <- dplyr::group_by(co_co2_ch4, id, pol) %>%
                dplyr::summarise(ppm = mean(val, na.rm = TRUE),
                                 qc = first(qc)) %>%
                dplyr::ungroup()
```

* convert mixing ratio to mass (assuming constant T and P)

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  co_co2_ch4 <- dplyr::left_join(co_co2_ch4,
                                 dplyr::select(pol_properties,
                                               pol,
                                               mw,
                                               num_c), by = "pol") %>%
                dplyr::mutate(conc = convert_ppmv_ugpmc(ppm, mw, 25, 84))
```

* merge with sample time data and calculate test duration

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  co_co2_ch4 <- dplyr::left_join(co_co2_ch4, times_test, by = "id") %>%
                dplyr::mutate(dur = end - start) %>%
                dplyr::mutate(id = as.factor(id))
```

* combine background for all pollutants

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  bg <- dplyr::bind_rows(bg_co, bg_co2, bg_ch4)
```

* merge background with fivegas data

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  co_co2_ch4 <- dplyr::left_join(co_co2_ch4, 
                dplyr::select(bg, id, pol, bg_ppm), by = c("id", "pol"))
```

* calculate micrograms emitted during tests (background-corrected mass emitted)

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  co_co2_ch4 <- dplyr::mutate(co_co2_ch4,
                              mass_emitted = (conc - bg_ppm) * hood_flow * (dur / 60),
                              num_c = 1,
                              mass_carbon = mass_emitted * (mw_c * num_c / mw),
                              inst = "fivegas")
```

* output

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  head(co_co2_ch4, 2)
```

___

# PAX - DATA GOOD BUT HAVE NOT ATTEMPTED TO RUN CODE YET - no code from main aim 1? 

* xyz

___

# grav - FIRST ATTEMPT DONE as of 6/27/17; note question on negative emissions

* select data

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  grav <- dplyr::select(grav_merged,
                        id, pol,
                        start, end,
                        flow_mean,
                        delta,
                        bg_conc, qc, conc) %>%
          dplyr::filter(grepl("^[A-Z]", id) == FALSE)
```

* calculate concentrations

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  grav <- dplyr::mutate(grav, dur = (end - start) / 60,
                              qc = as.factor(qc))
```

* calculate mass emitted (using 'conc', the calibration and blank corrected concentration)

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  grav <- dplyr::mutate(grav, 
                        mass_emitted = (conc - bg_conc) * hood_flow * dur,
                        mass_carbon = mass_emitted * 0, #0 because EC/OC accounts for the carbon in the PM.  
                        inst = "grav")
```

* output

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  head(grav, 2)
```

___

# pah - NO DATA YET

* waiting on data

___

# voc

* select data

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  voc <- dplyr::select(voc_merged,
                       id,
                       time_start, time_end,
                       pol, ppb,
                       ppb_bg, qc) %>%
         dplyr::left_join(dplyr::select(pol_properties,
                                        pol,
                                        mw,
                                        num_c), by = "pol") %>% 
         dplyr::filter(grepl("^[A-Z]", id) == FALSE)
```

* calculate concentrations

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  voc <- dplyr::mutate(voc, dur = (time_end - time_start) / 60,
                            ppm = ppb / 1000,
                            conc = convert_ppmv_ugpmc(ppm, mw, 25, 85),
                            conc_bg = convert_ppmv_ugpmc(ppb_bg / 1000, mw, 25, 85))
```

* calculate mass emitted

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  voc <- dplyr::mutate(voc, mass_emitted = (conc - conc_bg) * hood_flow * dur,
                            mass_carbon = mass_emitted * (mw_c * num_c / mw),
                            inst = "voc")
```

* output

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  head(voc, 2)
```

___

# Output

## combine pollutants

* mass based

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  emissions <- dplyr::select(co_co2_ch4, id, pol, 
                                         conc, #conc_bg, change name from bg_ppm to conc_bg (no conversions necessary)
                                         mass_emitted,
                                         mass_carbon,
                                         inst, qc) %>%
               dplyr::bind_rows(dplyr::select(
                 carbonyls, id, pol,
                                                         conc, #conc_bg, change from bg_mean to conc_bg - need to convert? 
                                                         mass_emitted,
                                                         mass_carbon,
                                                         inst, qc) %>%
               #dplyr::bind_rows(dplyr::select(ecoc, id, pol,
               #                                     conc, conc_bg,
               #                                     mass_emitted,
               #                                     mass_carbon,
               #                                     inst, qc)) %>%
               dplyr::bind_rows(dplyr::select(grav, id, pol,
                                                    conc, #conc_bg, need to change name from bg_conc to conc_bg
                                                    mass_emitted,
                                                    mass_carbon,
                                                    inst, qc)) %>%
               dplyr::bind_rows(dplyr::select(voc, id, pol,
                                                   conc, #conc_bg, conc_bg vs ppb_bg: what's difference? ppm vs conc for main value too? 
                                                   mass_emitted,
                                                   mass_carbon,
                                                   inst, qc))) #%>%
               #dplyr::bind_rows(dplyr::select(pax, id, pol,
               #                                     conc, conc_bg,
               #                                     mass_emitted,
               #                                     mass_carbon,
               #                                     inst, qc)) %>%
               #dplyr::bind_rows(dplyr::select(pah, id, pol,
               #                                     conc, conc_bg,
               #                                     mass_emitted,
               #                                     mass_carbon,
               #                                     inst, qc)) %>%
```

* convert to longer format

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  emissions_long <- tidyr::gather(emissions, "metric", "value", 3:6)
```


## save

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  saveRDS(emissions_long, file = "../r_files/emissions_long.RDS")
```


## negative emissions

* tests with negative net emissions

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE, fig.width=10, fig.height=40} 
  kable(dplyr::filter(emissions, mass_emitted < 0),
        align = 'c', caption = "Tests with negative values")
```
