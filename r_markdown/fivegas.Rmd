---
title: "Fivegas Data Processing"
output:
  html_document:
    toc: true
    toc_float: true
    theme: united
---

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  library(tidyverse)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  source("../r_scripts/R_tidy.R")
  source("../r_scripts/R_functions.R")
```

# Load data

* fivegas

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  data <- readRDS("../r_files/fivegas.RDS")
```

* sample information

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  test_info <- readRDS("../r_files/test_info.RDS")
  notes <- readRDS("../r_files/qc.RDS")
```

* sample times

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  times_fuel <- readRDS("../r_files/times_fuel.RDS")
  times_bg <- readRDS("../r_files/times_bg.RDS")
  times_test <- readRDS("../r_files/times_test.RDS")
```

* notes

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
 
```

# Units

* Convert co2 from percent to ppm.

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  out <- dplyr::mutate(data, co2 = co2 * 10^4)
```

# Convert to longer format

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
 out <- tidyr::gather(out, "pol", "val", 1:5) %>%
        dplyr::filter(grepl("^co$|^co2$|^ch4$", pol))
```

# Filter times

* full test

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  out_full <- filter_times_startup(times_test, out)
```

* background levels

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  out_bg <- filter_times_background(times_bg, out)
```

* levels by replicate

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  out_rep <- filter_times_rep(times_fuel, out)
```

## Background

* calculate mean backgrounds

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  bg <- dplyr::group_by(out_bg, id, type, pol) %>%
        dplyr::summarise(mean = mean(val, na.rm = TRUE)) %>%
        tidyr::spread(type, mean) %>%
        mutate(delta = post - pre,
               bg_ppm = (pre + post) / 2,
               bg_ppm = ifelse(is.na(bg_ppm), pre, bg_ppm),
               bg_ppm = ifelse(is.na(bg_ppm), post, bg_ppm))
```

* append to fivegas data

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  out_full <- dplyr::left_join(out_full,
                               dplyr::select(bg, id, pol, bg_ppm),
                               by = c("id", "pol"))

  out_rep <- dplyr::left_join(out_rep,
                              dplyr::select(bg, id, pol, bg_ppm),
                              by = c("id", "pol"))
```

# QC

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  notes <- dplyr::filter(notes, grepl("fivegas|all", instrument))

  out_full <- dplyr::left_join(out_full, 
                              dplyr::select(notes, id, qc),
                              by = "id")
  
  out_rep <- dplyr::left_join(out_rep,
                              dplyr::select(bg, id, pol, bg_ppm),
                              by = c("id", "pol"))
  
  out_bg <- dplyr::left_join(out_bg,
                             dplyr::select(bg, id, pol, bg_ppm),
                             by = c("id", "pol")) 
```

# Save to file

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  saveRDS(out_full, file = "../r_files/fivegas_full.RDS")
  saveRDS(out_bg, file = "../r_files/fivegas_background.RDS")
  saveRDS(out_rep, file = "../r_files/fivegas_byrep.RDS")
```

# Summary

Fivegas data was collected during `r length(unique(out_full$id))` experiments between `r min(out_full$date, na.rm = TRUE)` and `r max(out_full$date, na.rm = TRUE)`. There is no fivegas data for tests: `r setdiff(as.character(test_info$id), as.character(out_full$id))`.

Tests 36 through 43 are blanks; no fivegas data expected.


# Plots

* tests

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE, fig.width=12, fig.height=40, eval=TRUE}
  ggplot(out_full, aes(datetime, val, color = pol )) + 
    geom_point() +
    scale_y_log10() +
    facet_wrap(~id, ncol = 3, scale = "free") +
    theme_minimal() +
    xlab("") +
    theme(legend.position = "top")
```
* background

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE, fig.width=12, fig.height=40, eval=TRUE}
  ggplot(out_bg, aes(datetime, val, color = pol )) + 
    geom_point() +
    scale_y_log10() +
    facet_wrap(~id, ncol = 3, scale = "free") +
    theme_minimal() +
    xlab("") +
    theme(legend.position = "top")
```

* replicates

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE, fig.width=12, fig.height=40, eval=TRUE}
  ggplot(out_rep, aes(datetime, val, color = rep)) + 
    geom_point() +
    scale_y_log10() +
    facet_wrap(~id, ncol = 3, scale = "free") +
    theme_minimal() +
    xlab("") +
    theme(legend.position = "top")
```
