---
title: "Fivegas Data Processing"
output:
  html_document:
    toc: true
    toc_float: true
    theme: united
---

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  library(tidyverse)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  source("../r_scripts/R_tidy.R")
  source("../r_scripts/R_functions.R")
```

# Load data

* data logged in ppm units.

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  fivegas<- readRDS("../r_files/fivegas.RDS")    
```

* sample information

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  #load("../r_files/samples.Rda")
```

* notes

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  #load("../r_files/notes.Rda")
```

# Reformat data

## concentration

Convert concentration data to longer format

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
#Edited 7/12/17   
  fivegas_conc <- tibble::as_tibble(dplyr::select(fivegas,
                                                  -date,-time_s,
                                                  -time) %>%
                  tidyr::gather("pol", "ppm", ch4:co))
```

```{r, echo=FALSE, message=FALSE, warning=FALSE, results='hide', cache=FALSE}
 head(fivegas_conc, 2)
```

Remove oxygen rows (channels not used during study)

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
 fivegas_merged <- dplyr::filter(fivegas_conc, pol != "o2")
```


# QC

Extract notes relevant to  fivegas analyzer

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  #notes <- dplyr::filter(notes, grepl("fivegas|all", notes$inst) == TRUE)
```

Flag bad data from notes and plots

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  #notes$qc[33:35] <- "ok"
```

Make one flag per test precidented from bad to ok.

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  # flags <- dplyr::select(notes, id, qc) %>%
  #          dplyr::group_by(id) %>%
  #          dplyr::arrange(qc) %>%
  #          dplyr::summarise(qc = first(qc))
```

Merge with data

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  # fivegas_merged <- dplyr::left_join(fivegas_merged, flags, by = "id") %>%
  #                   dplyr::mutate(id = as.factor(id),
  #                                 qc = as.factor(ifelse(is.na(qc),
  #                                                "ok", as.character(qc))))

```

Additional bad tests

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  # fivegas_merged$qc[fivegas_merged$id == "23B"] <- "bad"  # CO:CH4
  # fivegas_merged$qc[fivegas_merged$id == "17C"] <- "bad"  # CO2
  # fivegas_merged$qc[fivegas_merged$id == "4B"] <- "bad"   # CO2
  # fivegas_merged$qc[fivegas_merged$id == "18C"] <- "bad"  # CH4
```

# Save merged file

```{r, echo=TRUE, warning=FALSE, message=FALSE, results='markup', cache=FALSE}
  saveRDS(fivegas_merged, file = "../r_files/fivegas_merged.RDS")
```

# Summary

The Fivegas analyzer measured during `r length(unique(fivegas_merged$id))` experiments between `r min(fivegas_merged$date, na.rm = TRUE)` and `r max(fivegas_merged$date, na.rm = TRUE)`. There is no $Fivegas$ data for tests: `r #setdiff(as.character(samples$id), as.character(fivegas_merged$id))`.

$Fivegas$ data is expected to be missing for: 

# Plots

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='markup', cache=FALSE, fig.width=12, fig.height=40, eval=TRUE}
  df <- dplyr::mutate(fivegas_merged, id = as.character(id)) %>%
        dplyr::arrange(id) %>%
        dplyr::mutate(id = as.factor(id))

  ggplot(df, aes(datetime, ppm, group = pol)) + 
    geom_line() +
    scale_y_log10(limits = c(1, 10^3)) +
    scale_colour_manual(values = 
                        c("ok" = "mediumaquamarine",
                          "maybe" = "mediumorchid1",
                          "bad" = "darkorange1")) +
    facet_wrap(~id, ncol = 3, scale = "free") +
    theme_minimal() +
    xlab("") +
    theme(legend.position = "top")
```
